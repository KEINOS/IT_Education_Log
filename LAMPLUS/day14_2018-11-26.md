20181126 教育内容

## 復習

- GitHub Pages のブログ環境を整備する
    - Markdown でかけるようにする
    - index をどう楽をして作るか
        - contents ディレクトリから情報取得
        - index.md に目次を作成
        - 上記を Git フックで自動化

- hook（フック）
    - ハンガーのフック
    - フック船長の右手のフック
    - フックを外す
    - 鼻フック
    - → 引っ掛ける、釣る
    - → トリガーのようなもの（アクションがあると連動・連鎖する）
    - → 引っかかるとフックが外れて罠が発動するようなイメージ
        - Web フック
            - tcp 経由で api などが叩かれる（呼び出される）
        - Git フック
            - ".git" の "hooks" にあるファイル
            - shebang 付きのファイル（基本 bash）

- POST/GET
    - Web でのデータ受け取りの重要な基本
    - POST はスクリプトの標準入力的なもの
    - GET はスクリプトの引数入力的なもの
    - `https://www.google.co.jp/search?q=hoge`
        - スクリプトは search
        - "q=hoge" が引数
        - URL アクセス → Web サーバーにリクエスト（Apache, NGINX）→ 紐付けされたスクリプトを実行
            - PHP や Python は Web サーバーからの受け取りを標準で装備している
    - "https://www.google.co.jp/search" → API のエンドポイントとも言う
    - WEB アプリは CLI アプリを拡張したもの
    - POST受け取り
        - 大きなファイルの場合が多い
        - アプリが起動してから、セッションを確立してデータを受け取る
            - メモリに入れずにディスクに直接置ける（メモリに入れなくても良い）
    - GET受け取り（URL渡し）
        - 軽量なデータの場合が多い
        - アプリが起動した時点で受け取っているので、メモリに入れないといけない
        - 本当は受け取れるデータ量は制限はない（メモリが許す範囲で）
            - BUT ブラウザ側がハネる場合がある（URLの文字数制限）
                - メモリ・オーバーフローを狙った攻撃が昔多かったため
        - 上記歴史により、大きなデータをGET渡しするのはよくないとされる
            - 「URL に画像や動画データを埋め込むのは良くない」など
    - `open()` コマンドは読み込みの「針」を移動させているだけ
        - `read()` で読み込み → メモリへ（速い, 容量を気にしないといけない）
        - `write()` で書き込み → ストレージへ（遅い, 容量は気にしなくていい）

- LINE アプリ
    - ユーザーからのアクションで、自分の API に WebHook で叩かれてレスポンスするもの
    - ユーザーからアプリのアカウントにトークする
        - トーク内容が API に送られてくる
        - アプリ内でトーク内容を解析・処理
        - 処理結果を表示する（返す）

- PRE/POST
    - PRE → 〜より前（PRE-LOAD, PREFIX 前置詞）
        - "pre-commit" → コミットを行う前
    - POST → 〜より後（ポスト山口百恵,ポスト安室奈美恵, POSTFIX 後置詞）
        - "post-commit" → コミット後

- IoTの場合
    - デバイスからサーバーに hook しているだけ
        - "http://192.168.1.1/myApp?button=push"
        - "http://192.168.1.1/myApp?temperature=34"

- 定例処理の促しアプリの場合
    1. ●●時までにサーバーに報告する
        - 受け取ったら JSON ファイルにログ出力
    2. ●●時までに報告がなければ、サーバーからメール or Line でうながす
        - cron で●●時に自動実行
            - JSON ファイルをチェック、報告がなければ通知

## ハッシュ関数の復習

### 特徴
1. **同じ長さである：**（固定長）<br>任意の長さの入力値に対して常に同じ長さの戻り値が返ってくる（128ビット長など）
2. **同じ結果になる：**（同一性）<br>入力値が同じ場合、戻り値の結果が常に同じである

### 性質

1. **非可逆である：**（一方向性）<br>戻り値から入力値を求める事が困難
    - 一番困難
2. **同じ戻り値を見つけづらい：**（第二原像困難性）<br>`$x` がわかっていて `hash($x) == hash($y)` となる `$x` とは異なる `$y` の値を見つけることが困難
    - hash($x) と衝突する $y を見つけることが困難
    - 二番目に困難
3. **戻り値が同じ値を見つけづらい：**（衝突困難性）<br>`hash($x) == hash($y)` となる `$x`と`$y` の値を見つけることが困難
    - 衝突する $x と $y の２つを見つけることが困難
    - 三番目に困難

### ハッシュと nonce と改ざん

- nonce/マイニング（特徴２を応用）
    - $hash_previous = hash(前の行のデータ)
    - hash($data + $hash_previous + $nonce) == hash($data + $hash_previous + $nonce)
        - → $nonce を探し、同一性を検証する
    - hash($data + $hash_previous + $nonce) = "00000xxxxxxxxxxxxxx" であるか（検証）
        - 検証の結果、条件を満たしていた場合は、台帳に追加

- 改ざん（性質２の応用）
    - hash($x) == hash($y + $z) → $y = 改ざんデータ, $z = nonce or salt

### ブロックチェーンを使うメリットがあるもの

- データの変更が許されないもの
    - 入金/出金の台帳など
    - ログ（センサーのデータ記録）など
    - 制定された文書など
    - 公開文書の証明
        - ハッシュ値も同時に公開することで、公式文書の証明にもなる
        - 実際にはハッシュ値を秘密鍵で暗号化したデータを公開する
            - 公開鍵で復号して、文書のハッシュ値を比べる
            - この仕組みを電子署名と言う
- ぶっちゃけ train Muscle のデータをブロックチェーンにするメリットは低い
- 改ざんの検知と、改ざんの防止を同じと考えないこと

### ブロックチェーンの基本

- 改ざんが検知できること
- 改ざん防止のための運用
    - nonce の探索（マイニング）
    - 台帳の分散
    - チェーンが一番長いものを「正」とする
    - etc.

### ビットコインの埋蔵量

- 有限
    - ICO
        - Initial Coin Offering（新規仮想通貨公開）
    - なぜ有限か
        - Coin 自体がハッシュ・データだから
            - 16進数の数値で長さが固定 → ∴ 有限（64桁の16進ぶんしか表現できない）
            - 厳密には素数も使う
        ```
        $id = 'oka'
        for i in range(1000000):
            coin = [hash('sha256', i)]
        ```

- 鳩ノ巣原理
    - 「鳩の数より巣箱の数が少ない場合は、同じ巣箱に鳩が２羽以上必ず入る」原理
    - 「同じ巣箱に鳩が入る」→ 衝突 / コリジョン

- 連番が一番確実
    - 番号から推測できてしまう

- ICO は株の公開と同じようなもの
    - 株の上場は、外部（知らない人）から新規資本を得るため
        - 新しく株を発行するから●●円で買ってね → ICO も同じ
    - 公開株か非公開株か
        - コネがあるか、ないか

## 会社の仕組み

- 法律上の「社員」は株を持っている人を指す
    - （いわゆる）社員は、パートやアルバイトと同じ → 従業員
- 「社」
    - 出資者のあつまりのこと
    - 「社」＝法律上１人の人間として扱う（法人＝人格権）
    - 株式会社, 有限会社, 合資会社, 合名会社
        - 有限会社はいまは新規では作れない
        - 主な違い
            - 有限責任か無限責任か
        - 有限責任
            - 株式会社（株単位で出資）, 有限会社（現金で出資）, 合名会社（株or現金で出資）
        - 無限責任
            - 合資会社（現金で出資）
            - 「法人」ではないが、個人事業主（人格が本人だから）
        - 出資の総額が「資本金」
        - 出資者＝役員
            - 出資者は経営には口を出せないが、経営者を決める権利を持っている
            - 経営者＝従業員＝取締役
    - 有限・無限
        - 負債 → 負債の支払い義務
        - 会社が倒産した場合
            - 有限は「出資したぶんだけ」責任を背負えば
            - 無限は「負債のぶん」責任を背負わないと
        - 出資者が出資金調達のために金融機関から借りたものは無限責任
    - ストックオプション
        - 給料以外に株も社員が買える権利（社員が本当の意味での「社員」になる）
        - 「社員」になって「社長」の不信任を言えるようになる
    
## Web サーバーを建てよう

- プログラム言語が標準で持っているサーバー
    - ビルトイン Web サーバー
    - 検証, 簡易動作チェックに向いている
    - 一般用途には向かない
        - メモリ管理, セキュリティ, アクセス制限, etc. の力不足
- Web サーバーの有名どころ
    - Apache（アパッチ）
        - CUI でも GUI でも管理画面が充実している
        - 歴史がある
        - オープンソースの老舗
    - Nginx（エンジンエックス）
        - 強み：プロキシ機能が得意
            - ルーター,ポートフォワード, パイプ的に内部で転送可能
            - サービスごとにポートを提供できたりする
        - オープンソースのルーキー
    - IIS
        - オンプレミスの老舗（ソースコードはわからない）

### シェルの復習

- OS のコア部分（Linuxだとカーネル）とのやり取りをする I/O の部分
    - ユーザーが見て・触れるもの
    - コマンド・プロンプト（CUI シェル）
        - bash, PowerShell, sh, etc.
    - エクスプローラーもシェル（GUI シェル, dir コマンドの代わりだから）

### 流れ

1. RPi に Apache を入れる
2. 静的 Hello World で動作確認（HTML）
3. Python3 を CGI で動くようにする
4. 動的 Hello World で動作確認（print('<h1>hello world</h1>'））

#### CGI

- Webサーバー用語としての CGI
- ヒント
    - IPアドレスにおける 255.255.255.0 や 192.168.0.1
- Common Gateway Interface の略
- リクエストをどこに渡すかの設定と窓口
    - 拡張子が ".php" の場合は /usr/bin/env php に渡す
    - 拡張子が ".py" の場合は /usr/bin/env python3 に渡す
- "/usr/bin/env ???" に渡す機能をモジュールと呼ぶ
- ブラウザ → Webサーバー → 該当モジュール → 該当プログラム言語
- Python を CGI で動かすには
    - Python 用の Apache モジュールを有効にする
    - モジュールの紐付けを行う
        - 一般的には ".py" で紐づける
        - 機能的に ".html" にも紐付けられる
            - .html を紐づけるメリット
                - 裏でどんなプログラムで動いているか隠蔽できる
        - 応用（いさか上級な使い方）
            - https://hoge.com/data.json?id=hoge&type={'hoge':'fuga'}
                - ".json" に紐づけて、「動的」に JSON テキストを Python の print で出力も可能
                - "data.json" というファイル名の Python アプリ
                - evel 系で実行しないように注意
            - https://hoge.com/data.md
                - ".md" に紐づけて、「動的」に Markdown テキストを Python の print で出力も可能
                - "data.md" というファイル名の Python アプリ

### RPi に Apache 導入
- 先ず以下のコマンドを実行しRPiをアップデートする
    ```
    $ sudo apt update
    $ sudo apt upgrade
    ```
    - update → すでにインストール済みのパッケージを更新
    - upgrade → 不要なパッケージの削除とカーネルのアップデート

- Apache2のインストールを実行
    ```
    $ sudo apt install apache2
    $ sudo apt install apache2-dev → 拡張機能もインストール
    ```
    → 続きは day15_11月27日の教育内容へ


#### 復習

- パッケージ管理
    - apt と apt-get の違いは？
        - apt は apt-get の簡易版（機能を絞ったもの）で、Ubuntu（Debian）用のパッケージ管理ツール
    - pip と apt の違いは？
        - pip は Python 専用のパッケージ管理ツール
    - pip と anaconda の違いは？
        - anaconda は特定用途専用（Python + 他の言語のバイナリなど）のパッケージ管理ツール
- どのパッケージ管理ツールで入れたかが大事
    - 管轄が変わるので、アンインストールがスムーズにいかない
    - バージョン違いのアプリがインストールされる
- 例えば Apache で脆弱性のパッチがリリースされた
    - どうやってインストールしたかが、わからなかくなる
        - ソースからビルドしている（コンパイルされた）か？
        - apt で入れたかか？
        - anaconda で入れたかか？
        - etc.

## 課題

- デフォルト・ページを "Hello World" の適当な HTML に変える
- CGI（Python モジュール）を有効にする
    - "a2enmod"
- ".py" の紐付け（Python3 であること）
- "index.html" -> "index.py" に変更
    ```
    print('<h1>Hello World from Python</h1>')
    ```
- ブラウザからのアクセス（http://localhost/, http://192.168.11.4/）で表示されること
- Raspbian（Ubuntu）の Web セキュリティ設定の下調べ
    - チェックリスト
    - 適用（理解できたものだけ）
- RPi から Python で Gmail /携帯メールの飛ばし方
    - `$ python3 test_sendmail.py`  で GMail に Hello が飛べばよい
    - トークン（アプリケーション・トークン）
- IFTTT（if this, then that）
    - IFTTT とは何か
    - WebHook の総合サービス

- VSCode から SSH 経由で RPi のファイルをいじれること
    - 現在の SSH 接続は Ubuntu 経由 → Windows でも SSH が使えないといけない
    - 公開鍵、秘密鍵（~/.ssh）を Windows 側と共有する
        - GitHub のシンボリックリンク作成の応用
 
- ポートの解放
